use crate::*;

use base64::{encode};

const DEFAULT_ICON: &str = "data:image/svg+xml;base64,IDxzdmcgdmlld0JveD0iMCAwIDI4MCAyODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+IDxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0wIDBoMjgwdjI4MEgweiIvPiA8cGF0aCBkPSJNMjYwIDE2MGMwIDY2LjI3NC01My43MjYgMTIwLTEyMCAxMjBTMjAgMjI2LjI3NCAyMCAxNjAgNzMuNzI2IDQwIDE0MCA0MHMxMjAgNTMuNzI2IDEyMCAxMjB6IiBmaWxsPSIjODA4MDAwIi8+IDxtYXNrIGlkPSI5Y3pnM24iIG1hc2tVbml0cz0idXNlclNwYWNlT25Vc2UiIHg9IjgiIHk9IjAiIHdpZHRoPSIyNjQiIGhlaWdodD0iMjgwIj4gPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0yNzIgMEg4djE2MGgxMmMwIDY2LjI3NCA1My43MjYgMTIwIDEyMCAxMjBzMTIwLTUzLjcyNiAxMjAtMTIwaDEyVjB6IiBmaWxsPSIjZmZmIi8+IDwvbWFzaz4gPGcgbWFzaz0idXJsKCM5Y3pnM24pIj4gPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDAsIDM2KSI+PHBhdGggZD0iTTEwMCAwQzY5LjA3MiAwIDQ0IDI1LjA3MiA0NCA1NnY2LjE2NmMtNS42NzUuOTUyLTEwIDUuODg4LTEwIDExLjgzNHYxNGMwIDYuMDUyIDQuNDggMTEuMDU4IDEwLjMwNSAxMS44ODEgMi4wNjcgMTkuODA2IDE0LjQ1OCAzNi41NDEgMzEuNjk1IDQ0LjczVjE2M2gtNGMtMzkuNzY0IDAtNzIgMzIuMjM2LTcyIDcydjloMjAwdi05YzAtMzkuNzY0LTMyLjIzNi03Mi03Mi03MmgtNHYtMTguMzg5YzE3LjIzNy04LjE4OSAyOS42MjgtMjQuOTI0IDMxLjY5NS00NC43M0MxNjEuNTIgOTkuMDU4IDE2NiA5NC4wNTIgMTY2IDg4Vjc0YzAtNS45NDYtNC4zMjUtMTAuODgyLTEwLTExLjgzNFY1NmMwLTMwLjkyOC0yNS4wNzItNTYtNTYtNTZ6IiBmaWxsPSIjRkZEQkI0Ii8+PHBhdGggZD0iTTc2IDE0NC42MTF2OEE1NS43OSA1NS43OSAwIDAwMTAwIDE1OGE1NS43ODkgNTUuNzg5IDAgMDAyNC01LjM4OXYtOEE1NS43ODkgNTUuNzg5IDAgMDExMDAgMTUwYTU1Ljc5IDU1Ljc5IDAgMDEtMjQtNS4zODl6IiBmaWxsPSIjMDAwIiBmaWxsLW9wYWNpdHk9Ii4xIi8+PC9nPiA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4LCAxNzApIj48cGF0aCBkPSJNMTMyLjUgNTRjMTguNTAyIDAgMzMuNS05LjYyNiAzMy41LTIxLjVhMTQuMDggMTQuMDggMCAwMC0uMzc2LTMuMjMyQzIwMi43NiAzMi4xMzggMjMyIDYzLjE4IDIzMiAxMDEuMDUyVjExMEgzMnYtOC45NDhjMC0zOC4yMTcgMjkuNzc1LTY5LjQ4IDY3LjM5My03MS44NTVBMTQuMTA4IDE0LjEwOCAwIDAwOTkgMzIuNUM5OSA0NC4zNzQgMTEzLjk5OCA1NCAxMzIuNSA1NHoiIGZpbGw9IiM1MTk5RTQiLz4gPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTE2LCA2Nykgc2NhbGUoMC40IDAuNCkiPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNNzIuMiw0LjZMNTMuNCwzMi41Yy0xLjMsMS45LDEuMiw0LjIsMywyLjZMNzQuOSwxOWMwLjUtMC40LDEuMi0wLjEsMS4yLDAuNnY1MC4zYzAsMC43LTAuOSwxLTEuMywwLjVsLTU2LTY3IEMxNywxLjIsMTQuNCwwLDExLjUsMGgtMkM0LjMsMCwwLDQuMywwLDkuNnY3MC44QzAsODUuNyw0LjMsOTAsOS42LDkwYzMuMywwLDYuNC0xLjcsOC4yLTQuNmwxOC44LTI3LjljMS4zLTEuOS0xLjItNC4yLTMtMi42IGwtMTguNSwxNmMtMC41LDAuNC0xLjIsMC4xLTEuMi0wLjZWMjAuMWMwLTAuNywwLjktMSwxLjMtMC41bDU2LDY3YzEuOCwyLjIsNC41LDMuNCw3LjMsMy40aDJjNS4zLDAsOS42LTQuMyw5LjYtOS42VjkuNiBjMC01LjMtNC4zLTkuNi05LjYtOS42Qzc3LjEsMCw3NCwxLjcsNzIuMiw0LjZ6IiBmaWxsPSIjRkZGRkZGIi8+PC9nPjwvZz4gPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODYsIDEzNCkiPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMzUuMTE4IDE1LjEyOEMzNi4xNzYgMjQuNjIgNDQuMjI2IDMyIDU0IDMyYzkuODA0IDAgMTcuODc0LTcuNDI2IDE4Ljg5Mi0xNi45Ni4wODItLjc2Ny0uNzc1LTIuMDQtMS44NS0yLjA0SDM3LjA4OGMtMS4wOCAwLTIuMDc1IDEuMTc4LTEuOTcgMi4xMjh6IiBmaWxsPSIjMDAwIiBmaWxsLW9wYWNpdHk9Ii43Ii8+IDxwYXRoIGQ9Ik03MCAxM0gzOWE1IDUgMCAwMDUgNWgyMWE1IDUgMCAwMDUtNXoiIGZpbGw9IiNmZmYiLz4gPHBhdGggZD0iTTY2LjY5NCAyNy4xMzhBMTAuOTY0IDEwLjk2NCAwIDAwNTkgMjRjLTEuOCAwLTMuNS40MzMtNSAxLjItMS41LS43NjctMy4yLTEuMi01LTEuMi0yLjk5NSAwLTUuNzEgMS4xOTctNy42OTMgMy4xMzhBMTguOTMgMTguOTMgMCAwMDU0IDMyYzQuODggMCA5LjMyOS0xLjg0IDEyLjY5NC00Ljg2MnoiIGZpbGw9IiNGRjRGNkQiLz48L2c+IDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMiwgMTIyKSI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xNiA4YzAgNC40MTggNS4zNzMgOCAxMiA4czEyLTMuNTgyIDEyLTgiIGZpbGw9IiMwMDAiIGZpbGwtb3BhY2l0eT0iLjE2Ii8+PC9nPiA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4NCwgOTApIj48cGF0aCBkPSJNMjUgMjdzLTYgNy4yNy02IDExLjI3YTYgNiAwIDEwMTIgMGMwLTQtNi0xMS4yNy02LTExLjI3eiIgZmlsbD0iIzkyRDlGRiIvPiA8cGF0aCBkPSJNMzYgMjJhNiA2IDAgMTEtMTIgMCA2IDYgMCAwMTEyIDB6bTUyIDBhNiA2IDAgMTEtMTIgMCA2IDYgMCAwMTEyIDB6IiBmaWxsPSIjMDAwIiBmaWxsLW9wYWNpdHk9Ii42Ii8+PC9nPiA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4NCwgODIpIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTI2LjU0NyA2LjE0OGMtNS44MDcuMjY5LTE1LjE5NSA0LjQ4OC0xNC45NTMgMTAuMzQ0LjAwOC4xOTIuMjkuMjc2LjQyNy4xMjkgMi43NTUtMi45NiAyMi4zMTYtNS45NSAyOS4yMDUtNC4zNjUuNjMuMTQ1IDEuMTEtLjQ3Ny43MS0uOTI3LTMuNDIyLTMuODQ4LTEwLjE4Ni01LjQyNi0xNS4zODktNS4xOHptNTkuOTA2IDBjNS44MDcuMjY5IDE1LjE5NSA0LjQ4OCAxNC45NTMgMTAuMzQ0LS4wMDguMTkyLS4yOS4yNzYtLjQyNy4xMjktMi43NTUtMi45Ni0yMi4zMTYtNS45NS0yOS4yMDUtNC4zNjUtLjYzLjE0NS0xLjExLS40NzctLjcxLS45MjcgMy40MjItMy44NDggMTAuMTg2LTUuNDI2IDE1LjM4OS01LjE4eiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIuNiIvPjwvZz4gPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNywgMCkiPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMTgwLjE1IDM5LjkyYy0yLjc2LTIuODItNS45NjQtNS4yMTMtOS4wODEtNy42MTMtLjY4Ny0uNTMtMS4zODYtMS4wNDYtMi4wNTgtMS41OTUtLjE1My0uMTI1LTEuNzE5LTEuMjQ2LTEuOTA2LTEuNjU5LS40NTEtLjk5My0uMTktLjIyLS4xMjgtMS40MDQuMDc5LTEuNDk4IDMuMTM0LTUuNzMuODU0LTYuNy0xLjAwMy0uNDI3LTIuNzkxLjcwOS0zLjc1MyAxLjA4NGE1OS41NTggNTkuNTU4IDAgMDEtNS43MzEgMS45Yy45MzItMS44NTcgMi43MDgtNS41NzMtLjYzMS00LjU3OS0yLjYwMi43NzUtNS4wMjYgMi43NjgtNy42NCAzLjcwNS44NjUtMS40MTggNC4zMjQtNS44MTEgMS4xOTgtNi4wNTctLjk3Mi0uMDc2LTMuODAzIDEuNzQ4LTQuODUgMi4xMzgtMy4xMzcgMS4xNjUtNi4zNDEgMS45Mi05LjYzNCAyLjUxMy0xMS4xOTggMi4wMTgtMjQuMjkzIDEuNDQyLTM0LjY1MyA2LjU0LTcuOTg3IDMuOTMtMTUuODc0IDEwLjAyOS0yMC40ODkgMTcuNzk0LTQuNDQ3IDcuNDg2LTYuMTEgMTUuNjc3LTcuMDQxIDI0LjI1NC0uNjgzIDYuMjk1LS43MzkgMTIuODAyLS40MiAxOS4xMTkuMTA1IDIuMDcuMzM4IDExLjYxMSAzLjM0NSA4LjcyMSAxLjQ5OC0xLjQ0IDEuNDg3LTcuMjUzIDEuODY0LTkuMjIuNzUxLTMuOTE2IDEuNDc0LTcuODQ4IDIuNzI2LTExLjYzOCAyLjIwNi02LjY4IDQuODA5LTEzLjc5MyAxMC4zMDUtMTguMzkzIDMuNTI3LTIuOTUyIDYuMDA0LTYuOTQxIDkuMzc5LTkuOTE5IDEuNTE2LTEuMzM3LjM1OS0xLjE5OCAyLjc5Ny0xLjAyMiAxLjYzOC4xMTcgMy4yODIuMTYyIDQuOTIzLjIwNSAzLjc5Ni4wOTkgNy41OTguMDc0IDExLjM5NS4wODcgNy42NDcuMDI4IDE1LjI1OC4xMzYgMjIuODk4LS4yNjUgMy4zOTUtLjE3NyA2Ljc5OS0uMjc0IDEwLjE4NS0uNTg4IDEuODkxLS4xNzUgNS4yNDctMS4zODcgNi44MDQtLjQ2MSAxLjQyNS44NDcgMi45MDUgMy42MTUgMy45MjggNC43NDggMi40MTggMi42NzkgNS4zIDQuNzI0IDguMTI2IDYuOTIgNS44OTUgNC41OCA4Ljg3IDEwLjMzMiAxMC42NjEgMTcuNDg4IDEuNzgzIDcuMTMgMS4yODMgMTMuNzQ1IDMuNDkgMjAuNzYyLjM4OSAxLjIzNCAxLjQxNiAzLjM2IDIuNjgyIDEuNDU0LjIzNS0uMzU0LjE3NS0yLjMuMTc1LTMuNDIgMC00LjUyIDEuMTQ0LTcuOTEgMS4xMy0xMi40Ni0uMDU2LTEzLjgzMi0uNTA0LTMxLjg2OC0xMC44NS00Mi40Mzl6IiBmaWxsPSIjMkMxQjE4Ii8+PC9nPiA8L2c+IDwvc3ZnPiA=";
const TOKEN_TITLE: &str = "Social Avatar NFT";
const TOKEN_DESCRIPTION: &str = "Generative avatar from Near.Social";

near_contract_standards::impl_non_fungible_token_core!(Contract, tokens);
near_contract_standards::impl_non_fungible_token_approval!(Contract, tokens);
near_contract_standards::impl_non_fungible_token_enumeration!(Contract, tokens);

#[near_bindgen]
impl NonFungibleTokenMetadataProvider for Contract {
    fn nft_metadata(&self) -> NFTContractMetadata {
        self.metadata.get().unwrap()
    }
}

impl Contract {
    pub fn internal_mint(&mut self, owner_id: &AccountId, svg: &str, total_cost: Balance) -> Token {
        let media = format!("data:image/svg+xml;base64,{}", encode_base64(svg));
        let token = self.tokens.internal_mint(
            format!("Avatar #{}", self.next_token_id),
            owner_id.to_owned(),
            Some(TokenMetadata {
                title: Some(TOKEN_TITLE.to_string()),
                description: Some(TOKEN_DESCRIPTION.to_string()),
                media: Some(media),
                media_hash: None,
                copies: None,
                issued_at: None,
                expires_at: None,
                starts_at: None,
                updated_at: None,
                extra: Some(format!(r#"{{"mint_price":"{}"}}"#, total_cost)),
                reference: None,
                reference_hash: None,
            }));

        self.next_token_id += 1;
        token
    }
}

pub fn internal_get_metadata() -> NFTContractMetadata {
    NFTContractMetadata {
        spec: NFT_METADATA_SPEC.to_string(),
        name: "Social Avatar NFT".to_string(),
        symbol: "SOCIAL_AVATAR".to_string(),
        icon: Some(DEFAULT_ICON.to_string()),
        base_uri: None,
        reference: None,
        reference_hash: None,
    }
}


pub fn encode_base64(input: &str) -> String {
    encode(input)
}